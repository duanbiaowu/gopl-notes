# 第10章 包和工具

## 10.1 引言

```go
// 查看标准包的具体数目
go list std | wc -l
```

每个包一般都定义了一个不同的名字空间用于它内部的每个标识符的访问。每个名字空间关联到一个特定的包，让我们给类型、函数等选择简短明了的名字，这样可以在使用它们的时候减少和其它部分名字的冲突。

每个包还通过控制包内名字的可见性和是否导出来实现封装特性。通过限制包成员的可见性并隐藏包API的具体实现，将允许包的维护者在不影响外部包用户的前提下调整包的内部实现。通过限制包内变量的可见性，还可以强制用户通过某些特定函数来访问和更新内部变量，这样可以保证内部变量的一致性和并发时的互斥约束。

**当我们修改了一个源文件，我们必须重新编译该源文件对应的包和所有依赖该包的其他包。**

Go语言编译速度明显快于其它编译语言：

- 所有导入的包必须在每个文件的开头显式声明
  - 编译器就没有必要读取和分析整个源文件来判断包的依赖关系
- 禁止包的环状依赖
  - 因为没有循环依赖，包的依赖关系形成一个有向无环图，每个包可以被独立编译，而且很可能是被并发编译
- 编译后包的目标文件不仅仅记录包本身的导出信息，目标文件同时还记录了包的依赖关系
  - 因此，在编译一个包的时候，编译器只需要读取每个直接导入包的目标文件，而不需要遍历所有依赖的的文件（译注：很多都是重复的间接依赖）

## 10.2 导入路径

**每个包是由一个全局唯一的字符串进行标识，称为导入路径。出现在import语句中的导入路径也是字符串。**

```go
// 为了避免冲突，所有非标准库包的导入路径建议以所在组织的互联网域名为前缀
// 而且这样也有利于包的检索
import (
    "fmt"
    "math/rand"
    "encoding/json"

    "golang.org/x/net/html"

    "github.com/go-sql-driver/mysql"
)
```

## 10.3 包声明

**在每个Go语言源文件的开头都必须有包声明语句。包声明语句的主要目的是确定当前包被其它包导入时默认的标识符（也称为包名）。**

```go
// 默认的包名就是包导入路径名的最后一段
// 即使两个包的导入路径不同，它们依然可能有一个相同的包名
// 两个包名都是 rand
import (
    // "crypto/rand"
    // "math/rand"
)
```

默认包名一般采用导入路径名的最后一段作为约定， 但是有三种例外情况：

- 包对应一个可执行程序，也就是main包

  - main包本身的导入路径是无关紧要的，名字为`main` 的包是给 `go build` 构建命令一个信息，这个包编译完之后必须调用连接器生成一个可执行程序

- 包所在的目录中可能有一些文件名是以`_test.go`为后缀的Go源文件，并且这些源文件声明的包名也是以`_test`为后缀名的

  - 文件名称前面必须有其它的字符，因为以`_`或`.`开头的源文件会被构建工具忽略
  - 目录可以包含两种包：一种是普通包，另一种则是测试的外部扩展包
  - `_test` 后缀告诉 `go test` 两个包都需要构建，并且指明文件属于哪个包

- 一些依赖版本号的管理工具会在导入路径后追加版本号信息

  ```go
  // 包的名字并不包含版本号后缀，而是yaml
  gopkg.in/yaml.v2
  ```

## 10.4 导入声明

导入的包之间可以通过添加空行来分组；通常将来自不同组织的包独自分组。包的导入顺序无关紧要，但是在每个分组中一般会根据字符串顺序排列。

```go
// gofmt和goimports工具都可以自动分组并排序
import (
    "fmt"
    "html/template"
    "os"

    "golang.org/x/net/html"
    "golang.org/x/net/ipv4"
)

// 重命名导入
// 除了命名冲突外，如果导入的包名很笨重，重命名一个简短名称会更方便
import (
    "crypto/rand"
    mrand "math/rand" // alternative name mrand avoids conflict
)
```

**每个导入声明从当前包向导入的包建立一个依赖，如果这些依赖形成一个循环， `go build` 会报错。** 

## 10.5 包的匿名导入

**如果导入的包的名字没有在文件中引用，就会产生一个编译错误。但是有时候导入一个包仅仅是为了利用其副作用：对包级别的变量执行初始化表示式求值，并执行它的init函数。这时需要抑制 `“unused import”` 编译错误，可以用下划线`_`来重命名导入的包。下划线`_`为空白标识符，并不能被访问，这称为 `空白导入`。**

## 10.6 包及其命名

包名一般采用单数的形式。标准库的bytes、errors和strings使用了复数形式，这是为了避免和预定义的类型冲突，同样还有go/types是为了避免和type关键字冲突。

```go
// 当设计一个包的时候，需要考虑包名和成员名两个部分如何很好地配合
bytes.Equal    flag.Int    http.Get    json.Marshal

package strings

func Index(needle, haystack string) int

type Replacer struct{ /* ... */ }
func NewReplacer(oldnew ...string) *Replacer

type Reader struct{ /* ... */ }
func NewReader(s string) *Reader
```

## 10.7 go工具

```go
// go或go help命令查看内置的帮助文档
go
...
    build            compile packages and dependencies
    clean            remove object files
    doc              show documentation for package or symbol
    env              print Go environment information
    fmt              run gofmt on package sources
...
```

### 10.7.1 工作空间的组织

```go
// 对于大多数的Go语言用户，只需要配置一个名叫GOPATH的环境变量，用来指定当前工作目录即可
// 当需要切换到不同工作区的时候，只要更新GOPATH
export GOPATH=$HOME/gobook
go get gopl.io/...
```

**GOPATH对应的工作区目录有三个子目录：**

- src子目录用于存储源代码
  - 每个包被保存在与$GOPATH/src的相对路径为包导入路径的子目录中
- pkg子目录用于保存编译后的包的目标文件
- bin子目录用于保存编译后的可执行程序

**GOROOT用来指定Go的安装目录，还有它自带的标准库包的位置。**

GOROOT的目录结构和GOPATH类似，因此存放fmt包的源代码对应目录应该为$GOROOT/src/fmt。用户一般不需要设置GOROOT，默认情况下Go语言安装工具会将其设置为安装的目录路径。



